<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ALL-SERVERS-STATS-FETCH</title>

  <style>
    body {
      background-color: rgba(0, 0, 0, 0);
      margin: 0px auto;
      font-family: 'Open Sans', sans-serif;
      overflow: hidden;
      color: #1e90ff;
      font-size: 22px;
      font-weight: 700;
      text-align: right;
      padding: 5px;
    }

    #bitrate * {
      vertical-align: middle;
    }

  </style>

</head>

<body>

  <div id="block_container">

    <div id="bitrate"></div>

  </div>

  <script>
    const tryFetch = async (page) => {
      try {
        return await fetch(page);
      } catch (error) {
        console.log(page, error);
      }

      return null;
    }

    const getSrtBitrate = async (page, publisher) => {
      const response = await tryFetch(page);
      if (!response) return null;

      const srtdata = await response.json();

      if (srtdata.publishers[publisher] == null) return null;

      const stream = srtdata.publishers[publisher];
      return stream.bitrate;
    };

    const getNmsBitrate = async (page) => {
      const response = await tryFetch(page);
      if (!response) return null

      const data = await response.json();

      if (!data.bitrate) return null;

      return data.bitrate;
    };

    const getNginxBitrate = async (page, key) => {
      const response = await tryFetch(page);
      if (!response) return null

      const data = await response.text();
      const parse = new window.DOMParser().parseFromString(data, "text/xml");
      const live = parse.getElementsByTagName(key)[0];

      const node = live.childNodes[1].childNodes[14];

      if (!node) return null;

      return Math.round(node.childNodes[0].nodeValue / 1024);
    };

    const run = async (stats, interval) => {
      setText(await getBitrate(stats))

      setInterval(async () => {
        setText(await getBitrate(stats));
      }, interval);
    }

    const getBitrate = async (stats) => {
      let get = {
        "SRT": getSrtBitrate,
        "NMS": getNmsBitrate,
        "NGINX": getNginxBitrate,
      }

      let values = await Promise.all(stats.map(s => get[s.server](s.page, s.key)));
      return values.find(el => el);
    }

    const setText = (bitrate) => {
      if (!bitrate) {
        document.getElementById('bitrate').innerHTML = "<img src='offline.png' style='width:41px;height:32px;'></a> NO SIGNAL";
        return;
      }

      document.getElementById('bitrate').innerHTML = "<img src='blank.png' style='width:41px;height:32px;'></a> " + bitrate + " kb/s";
    }
  </script>

  <script>
    let interval = 2000;
    let stats = [
      { server: "SRT", page: "http://127.0.0.1:8181/stats", key: "publish/live/feed1" },
      { server: "NMS", page: "http://localhost:8000/api/streams/live/feed1" },
      { server: "NGINX", page: "http://localhost/stat", key: "live" }
    ];

    run(stats, interval);
  </script>

</body>

</html>